<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RealEstate Finder - Find Your Dream Home</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./src/assets/styles/index.css" />

</head>
<body>
  <div id="root"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // Login Popup Component
    const LoginPopup = ({ isOpen, onClose }) => {
      const [activeTab, setActiveTab] = useState('signin');
      const [formData, setFormData] = useState({
        email: '',
        password: '',
        name: '',
        confirmPassword: ''
      });
      
      // If popup is not open, return null (but don't cause a render error)
      if (!isOpen) return null;
      
      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
          ...prev,
          [name]: value
        }));
      };
      
      const handleSubmit = (e) => {
        e.preventDefault();
        
        if (activeTab === 'signin') {
          // Handle sign in
          console.log('Sign in with:', formData.email, formData.password);
          // You would add authentication logic here
        } else {
          // Handle registration
          if (formData.password !== formData.confirmPassword) {
            alert('Passwords do not match!');
            return;
          }
          console.log('Register with:', formData.name, formData.email, formData.password);
          // You would add registration logic here
        }
        
        // For demo, just close the popup
        onClose();
      };
      
      const handleOverlayClick = (e) => {
        if (e.target.className === 'login-popup-overlay') {
          onClose();
        }
      };
      
      // Effect for event listener
      useEffect(() => {
        const handleEscKey = (e) => {
          if (e.key === 'Escape') onClose();
        };
        
        document.addEventListener('keydown', handleEscKey);
        return () => document.removeEventListener('keydown', handleEscKey);
      }, [onClose]);
      
      return (
        <div className="login-popup-overlay" onClick={handleOverlayClick}>
          <div className="login-popup-content">
            <button className="login-popup-close" onClick={onClose}>Ã—</button>
            
            <div className="login-popup-header">
              <h2>Welcome to RealEstate Finder</h2>
            </div>
            
            <div className="login-popup-tabs">
              <div 
                className={`login-popup-tab ${activeTab === 'signin' ? 'active' : ''}`}
                onClick={() => setActiveTab('signin')}
              >
                Sign in
              </div>
              <div 
                className={`login-popup-tab ${activeTab === 'register' ? 'active' : ''}`}
                onClick={() => setActiveTab('register')}
              >
                New account
              </div>
            </div>
            
            <form className="login-popup-form" onSubmit={handleSubmit}>
              {activeTab === 'register' && (
                <div className="login-popup-form-group">
                  <label htmlFor="name">Full Name</label>
                  <input 
                    type="text" 
                    id="name" 
                    name="name" 
                    value={formData.name}
                    onChange={handleChange}
                    placeholder="Enter your full name"
                    required={activeTab === 'register'}
                  />
                </div>
              )}
              
              <div className="login-popup-form-group">
                <label htmlFor="email">Email</label>
                <input 
                  type="email" 
                  id="email" 
                  name="email" 
                  value={formData.email}
                  onChange={handleChange}
                  placeholder="Enter your email"
                  required
                />
              </div>
              
              <div className="login-popup-form-group">
                <label htmlFor="password">Password</label>
                <input 
                  type="password" 
                  id="password" 
                  name="password" 
                  value={formData.password}
                  onChange={handleChange}
                  placeholder={activeTab === 'signin' ? "Enter your password" : "Create a password"}
                  required
                />
              </div>
              
              {activeTab === 'register' && (
                <div className="login-popup-form-group">
                  <label htmlFor="confirmPassword">Confirm Password</label>
                  <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirmPassword" 
                    value={formData.confirmPassword}
                    onChange={handleChange}
                    placeholder="Confirm your password"
                    required={activeTab === 'register'}
                  />
                </div>
              )}
              
              {activeTab === 'signin' && (
                <div className="login-popup-forgot">
                  <a href="#">Forgot your password?</a>
                </div>
              )}
              
              <button type="submit" className="login-popup-submit">
                {activeTab === 'signin' ? 'Sign in' : 'Create account'}
              </button>
              
              <div className="login-popup-divider">Or connect with</div>
              
              <div className="login-popup-social">
                <button type="button" className="login-popup-social-btn google">
                  <i className="fab fa-google"></i> Continue with Google
                </button>
                <button type="button" className="login-popup-social-btn facebook">
                  <i className="fab fa-facebook-f"></i> Continue with Facebook
                </button>
                <button type="button" className="login-popup-social-btn apple">
                  <i className="fab fa-apple"></i> Continue with Apple
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    
    
    // Format price with commas and dollar sign
    const formatPrice = (price) => {
      return `$${price.toLocaleString()}`;
    };

    // Map Component
    const MapComponent = ({ properties, selectedProperty, setSelectedProperty }) => {
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);
      const markersRef = useRef([]);
      
      useEffect(() => {
        if (!mapInstanceRef.current) {
          // Initialize map
          mapInstanceRef.current = L.map(mapRef.current).setView([40.7128, -74.0060], 13);
          
          // Add OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(mapInstanceRef.current);
        }
        
        // Clear existing markers
        markersRef.current.forEach(marker => marker.remove());
        markersRef.current = [];
        
        // Add markers for properties
        properties.forEach(property => {
          const marker = L.marker(property.location)
            .addTo(mapInstanceRef.current)
            .bindPopup(`
              <div class="map-popup">
                <img src="${property.images[0]}" alt="${property.title}" />
                <h3>${formatPrice(property.price)}</h3>
                <p>${property.bedrooms} BD | ${property.bathrooms} BA | ${property.squareFeet} SF</p>
                <p>${property.address}</p>
                <button class="view-btn" onclick="window.selectProperty(${property.id})">View Details</button>
              </div>
            `);
          
          marker.on('click', () => {
            setSelectedProperty(property.id);
          });
          
          // Highlight selected property
          if (property.id === selectedProperty) {
            marker.openPopup();
            mapInstanceRef.current.setView(property.location, 15);
          }
          
          markersRef.current.push(marker);
        });
        
        // Make the selectProperty function available to the popup button
        window.selectProperty = (id) => {
          setSelectedProperty(id);
        };
        
        return () => {
          // Clean up when component unmounts
          if (mapInstanceRef.current) {
            // Remove global function
            delete window.selectProperty;
          }
        };
      }, [properties, selectedProperty]);
      
      return <div id="map" ref={mapRef}></div>;
    };

    // Property Card Component
    const PropertyCard = ({ property, isSelected, onClick }) => {
      return (
        <div className={`property-card ${isSelected ? 'selected' : ''}`} onClick={onClick}>
          <img className="property-img" src={property.images[0]} alt={property.title} />
          <div className="property-price">{formatPrice(property.price)}</div>
          <div className="property-address">{property.address}</div>
          <div className="property-features">
            <div className="property-feature">
              <i className="fas fa-bed"></i>
              <span>{property.bedrooms} {property.bedrooms === 1 ? 'bed' : 'beds'}</span>
            </div>
            <div className="property-feature">
              <i className="fas fa-bath"></i>
              <span>{property.bathrooms} {property.bathrooms === 1 ? 'bath' : 'baths'}</span>
            </div>
            <div className="property-feature">
              <i className="fas fa-ruler-combined"></i>
              <span>{property.squareFeet} sq ft</span>
            </div>
          </div>
          <div className="property-description">{property.description}</div>
        </div>
      );
    };

    // Filters Component
    const FiltersPanel = ({ filters, setFilters, applyFilters }) => {
      const handleChange = (e) => {
        const { name, value, type, checked } = e.target;
        const newValue = type === 'checkbox' ? checked : value;
        
        setFilters(prev => ({
          ...prev,
          [name]: newValue
        }));
      };
      
      return (
        <div className="filters">
          <h2>Find Your Perfect Home</h2>
          
          <div className="filter-group">
            <label>Location</label>
            <input 
              type="text" 
              name="location" 
              placeholder="City, neighborhood, or address"
              value={filters.location}
              onChange={handleChange}
            />
          </div>
          
          <div className="filter-group">
            <label>Property Type</label>
            <select name="propertyType" value={filters.propertyType} onChange={handleChange}>
              <option value="">Any</option>
              <option value="house">House</option>
              <option value="apartment">Apartment</option>
              <option value="condo">Condo</option>
              <option value="townhouse">Townhouse</option>
              <option value="land">Land</option>
            </select>
          </div>
          
          <div className="filter-group">
            <label>Price Range</label>
            <div className="price-range">
              <input 
                type="number" 
                name="minPrice" 
                placeholder="Min"
                value={filters.minPrice}
                onChange={handleChange}
              />
              <input 
                type="number" 
                name="maxPrice" 
                placeholder="Max"
                value={filters.maxPrice}
                onChange={handleChange}
              />
            </div>
          </div>
          
          <div className="filter-group">
            <label>Bedrooms</label>
            <select name="bedrooms" value={filters.bedrooms} onChange={handleChange}>
              <option value="">Any</option>
              <option value="0">Studio</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
              <option value="4">4+</option>
              <option value="5">5+</option>
            </select>
          </div>
          
          <div className="filter-group">
            <label>Bathrooms</label>
            <select name="bathrooms" value={filters.bathrooms} onChange={handleChange}>
              <option value="">Any</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
              <option value="4">4+</option>
            </select>
          </div>
          
          <div className="filter-group">
            <label>Square Feet</label>
            <div className="price-range">
              <input 
                type="number" 
                name="minSqft" 
                placeholder="Min"
                value={filters.minSqft}
                onChange={handleChange}
              />
              <input 
                type="number" 
                name="maxSqft" 
                placeholder="Max"
                value={filters.maxSqft}
                onChange={handleChange}
              />
            </div>
          </div>
          
          <div className="filter-group">
            <label>Year Built</label>
            <div className="price-range">
              <input 
                type="number" 
                name="minYear" 
                placeholder="Min"
                value={filters.minYear}
                onChange={handleChange}
              />
              <input 
                type="number" 
                name="maxYear" 
                placeholder="Max"
                value={filters.maxYear}
                onChange={handleChange}
              />
            </div>
          </div>
          
          <div className="filter-group">
            <label>Features</label>
            <div className="checkbox-group">
              <div className="checkbox-item">
                <input 
                  type="checkbox" 
                  id="feature-garage" 
                  name="hasGarage"
                  checked={filters.hasGarage}
                  onChange={handleChange}
                />
                <label htmlFor="feature-garage">Garage</label>
              </div>
              <div className="checkbox-item">
                <input 
                  type="checkbox" 
                  id="feature-pool" 
                  name="hasPool"
                  checked={filters.hasPool}
                  onChange={handleChange}
                />
                <label htmlFor="feature-pool">Pool</label>
              </div>
              <div className="checkbox-item">
                <input 
                  type="checkbox" 
                  id="feature-ac" 
                  name="hasAC"
                  checked={filters.hasAC}
                  onChange={handleChange}
                />
                <label htmlFor="feature-ac">A/C</label>
              </div>
            </div>
          </div>
          
          <button className="search-btn" onClick={applyFilters}>
            <i className="fas fa-search"></i> Search
          </button>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const { language } = useLanguage();
      const t = translations[language];
      const [properties, setProperties] = useState(sampleProperties);
      const [filteredProperties, setFilteredProperties] = useState(sampleProperties);
      const [selectedProperty, setSelectedProperty] = useState(null);
      const [showFilters, setShowFilters] = useState(false);
      const [isLoginPopupOpen, setIsLoginPopupOpen] = useState(false);
      const [filters, setFilters] = useState({
        location: '',
        propertyType: '',
        minPrice: '',
        maxPrice: '',
        bedrooms: '',
        bathrooms: '',
        minSqft: '',
        maxSqft: '',
        minYear: '',
        maxYear: '',
        hasGarage: false,
        hasPool: false,
        hasAC: false
      });
      
      // Fetch properties from API
      useEffect(() => {
        // Replace this with actual API call in production
        const fetchProperties = async () => {
          try {
            // const response = await fetch('/api/properties');
            // const data = await response.json();
            // setProperties(data);
            // setFilteredProperties(data);
            
            // Using sample data for demo
            setProperties(sampleProperties);
            setFilteredProperties(sampleProperties);
          } catch (error) {
            console.error('Error fetching properties:', error);
          }
        };
        
        fetchProperties();
      }, []);
      
      // Add event listener to sign-in link - FIXED VERSION
      useEffect(() => {
        const signInLink = document.getElementById('sign-in-link');
        
        const handleSignInClick = (e) => {
          e.preventDefault();
          setIsLoginPopupOpen(true);
        };
        
        if (signInLink) {
          signInLink.addEventListener('click', handleSignInClick);
          
          // Cleanup function to prevent memory leaks
          return () => {
            if (signInLink) {
              signInLink.removeEventListener('click', handleSignInClick);
            }
          };
        }
      }, []); // Empty dependency array means this runs once on mount
      
      // Apply filters
      const applyFilters = () => {
        let filtered = [...properties];
        
        // Filter by property type
        if (filters.propertyType) {
          filtered = filtered.filter(p => p.propertyType === filters.propertyType);
        }
        
        // Filter by price range
        if (filters.minPrice) {
          filtered = filtered.filter(p => p.price >= parseInt(filters.minPrice));
        }
        if (filters.maxPrice) {
          filtered = filtered.filter(p => p.price <= parseInt(filters.maxPrice));
        }
        
        // Filter by bedrooms
        if (filters.bedrooms) {
          filtered = filtered.filter(p => p.bedrooms >= parseInt(filters.bedrooms));
        }
        
        // Filter by bathrooms
        if (filters.bathrooms) {
          filtered = filtered.filter(p => p.bathrooms >= parseFloat(filters.bathrooms));
        }
        
        // Filter by square feet
        if (filters.minSqft) {
          filtered = filtered.filter(p => p.squareFeet >= parseInt(filters.minSqft));
        }
        if (filters.maxSqft) {
          filtered = filtered.filter(p => p.squareFeet <= parseInt(filters.maxSqft));
        }
        
        // Filter by year built
        if (filters.minYear) {
          filtered = filtered.filter(p => p.yearBuilt >= parseInt(filters.minYear));
        }
        if (filters.maxYear) {
          filtered = filtered.filter(p => p.yearBuilt <= parseInt(filters.maxYear));
        }
        
        setFilteredProperties(filtered);
        setShowFilters(false); // Close filters on mobile after applying
      };
      
      // Toggle filters visibility on mobile
      const toggleFilters = () => {
        setShowFilters(!showFilters);
      };
      
      // Function to handle sign-in click directly (alternative approach)
      const handleSignInClick = (e) => {
        if (e) e.preventDefault();
        setIsLoginPopupOpen(true);
      };
      
      // Function to close the login popup
      const closeLoginPopup = () => {
        setIsLoginPopupOpen(false);
      };
      
      return (
        <>
          <header>
            <a href="#" className="logo">
              <i className="fas fa-home"></i>
              RealEstate Finder
            </a>
            <nav>
              <ul>
                <li><a href="#">Buy</a></li>
                <li><a href="#">Rent</a></li>
                <li><a href="#">Sell</a></li>
                <li><a href="#">Agents</a></li>
                <li><a href="#" id="sign-in-link" onClick={handleSignInClick}>Sign In</a></li>
              </ul>
            </nav>
          </header>
          
          <main>
            <div className={`filters ${showFilters ? 'active' : ''}`}>
              <FiltersPanel 
                filters={filters} 
                setFilters={setFilters} 
                applyFilters={applyFilters}
              />
            </div>
            
            <div className="map-container">
              <MapComponent 
                properties={filteredProperties} 
                selectedProperty={selectedProperty}
                setSelectedProperty={setSelectedProperty}
              />
              <button className="mobile-filters-toggle" onClick={toggleFilters}>
                <i className="fas fa-filter"></i> Filters
              </button>
            </div>
            
            <div className="property-list">
              {filteredProperties.map(property => (
                <PropertyCard 
                  key={property.id}
                  property={property}
                  isSelected={selectedProperty === property.id}
                  onClick={() => setSelectedProperty(property.id)}
                />
              ))}
              {filteredProperties.length === 0 && (
                <div style={{ padding: '2rem', textAlign: 'center' }}>
                  <p>No properties match your search criteria.</p>
                  <p>Try adjusting your filters.</p>
                </div>
              )}
            </div>
          </main>
          
          {/* Login Popup - Using conditional rendering */}
          {isLoginPopupOpen && (
            <LoginPopup 
              isOpen={isLoginPopupOpen} 
              onClose={closeLoginPopup} 
            />
          )}
        </>
      );
    };

    // Render the App
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>